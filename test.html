<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Date Difference</title>
  <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/duration.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_duration);

    // ფუნქცია სხვადასხვა თარიღების გამოთვლისთვის
    function computeDiffObject(from, to) {
      const a = dayjs(from);
      const b = dayjs(to);

      if(!a.isValid() || !b.isValid()){
        return { error: 'invalid date', from: String(from), to: String(to) };
      }

      let start = a, end = b;
      if (a.isAfter(b)) { start = b; end = a; }

      const years = end.diff(start, 'year');
      const afterYears = start.add(years, 'year');
      const months = end.diff(afterYears, 'month');
      const afterMonths = afterYears.add(months, 'month');
      const days = end.diff(afterMonths, 'day');
      const afterDays = afterMonths.add(days, 'day');
      const hours = end.diff(afterDays, 'hour');
      const afterHours = afterDays.add(hours, 'hour');
      const minutes = end.diff(afterHours, 'minute');
      const afterMinutes = afterHours.add(minutes, 'minute');
      const seconds = end.diff(afterMinutes, 'second');

      const totalMilliseconds = end.diff(start);
      const totalSeconds = Math.floor(totalMilliseconds / 1000);
      const totalDays = Math.floor(totalSeconds / (24 * 3600));

      const text = `${years} years ${months} months ${days} days ${hours} hours ${minutes} minutes ${seconds} seconds`;

      return {
        text,
        years, months, days, hours, minutes, seconds,
        totalDays, totalSeconds, totalMilliseconds,
        from: start.toISOString(),
        to: end.toISOString()
      };
    }

    // ფუნქცია, რომელიც Web Viewer-ს აგზავნის JSON-ს
    window.computeDiffAndSend = function(from, to) {
      const res = computeDiffObject(from, to);
      const payload = JSON.stringify(res);

      // WebView (Tunkable) დამუშავება
      if (window.ReactNativeWebView && typeof window.ReactNativeWebView.postMessage === 'function') {
        window.ReactNativeWebView.postMessage(payload);
      } else {
        // მხოლოდ კონსოლისთვის ტესტი
        console.log(payload);
      }
      return payload;
    };

    // მიიღეთ მესიჯი Web Viewer–დან
    window.addEventListener("message", function(event) {
      try {
        const data = JSON.parse(event.data);
        if (data.current && data.target) {
          window.computeDiffAndSend(data.current, data.target);
        }
      } catch(e) {
        console.error("Invalid message received:", event.data);
      }
    });
  </script>
</head>
<body>
  <h3>Date Difference Ready</h3>
  <p>გამოძახებისთვის გამოიყენეთ: <br>
  <code>window.computeDiffAndSend("2025-01-01", "2026-01-01")</code></p>
</body>
</html>
